<import src="../common/page_loading.wxml"/>
<import src="../common/comment_bottom_bar.wxml"/>

<nav isFromWeapp="{{isFromWeapp}}" title="{{navigateTitle}}"  pageLogin="{{isLogin}}"></nav>

<view class="u-container t-bg" style="padding-top: {{statusBarHeight}}px">
  <scroll-view scroll-y="{{true}}" bindscroll="scroll">
    <view class="article">
      <view class="title" id="js-article-title">{{title}}</view>
      <view wx:if="{{isFetching}}">
        <template is="page_loading" />
      </view>

      <block wx:if="{{!isFetching}}">
        <view class="info">
          <view class="left">
            <view class="avatar">
              <image wx:if="{{article.author.avatar_url}}" src="{{article.author.avatar_url}}" mode="aspectFill"></image>
            </view>
            <view class="author">{{article.author.name}}</view>
            <view wx-hidden="{{article.copyright === '' || article.copyright === undefined || article.copyright === null}}" class="copyright">{{article.copyright}}</view>
          </view>
          <view class="right">{{article.publishedAt}}</view>
        </view>
        <view class="content" id="js-article-content">
          <import src="../../wxParse/wxParse.wxml"/>
          <template is="wxParse" data="{{wxParseData:article_content.nodes}}" />
        </view>
      </block>
    </view>

    <block wx:if="{{article.related_nodes.length > 0}}">
      <view class="related_nodes">
        <view class="title">相关数据</view>
        <scroll-view scroll-x="{{true}}" style="width: 100%">
          <block wx:for="{{article.related_nodes}}" wx:key="unique">
            <view class="node_card" wx:if="{{item.level == 'level_1'}}">
              <view class="top">
                <view class="zh_name">{{item.zh_name}}</view>
                <view class="type">{{item.node_type}}</view>
              </view>
              <view class="en_name">{{item.en_name}}</view>
            </view>
            <navigator url="../{{item.node_type_en}}/{{item.node_type_en}}?id={{item.node_id}}&title={{item.zh_name ? item.zh_name : item.en_name}}" wx:else class="node_card can_click" id="{{item.node_id}}">
              <view class="top">
                <view class="zh_name">{{item.zh_name}}</view>
                <view class="type">{{item.node_type}}</view>
              </view>
              <view class="en_name">{{item.en_name}}</view>
            </navigator>
          </block>
        </scroll-view>
      </view>
    </block>

    <block wx:if="{{!isFetching}}">
      <comment isShowComment="{{isShowComment}}" baseUrl="/articles/{{id}}" bindclosecommentevent="closeComment" bindopencommentevent="openComment"></comment>

      <block wx:if="{{isLogin}}">
        <view class="u-fix-bottom {{isIphoneX ? 'has-safe-padding' : ''}}">
          <view class="u-fix-bottom--bar" bindtap="addRead">
            <image class="u-fix-bottom--icon" src="{{prePath}}/icons/article_delayread.png" />
            <text>稍后阅读</text>
          </view>
          <view class="u-fix-bottom--bar" bindtap="openComment">
            <image class="u-fix-bottom--icon" src="{{prePath}}/icons/article_comment.png" />
            <text>评论</text>
          </view>
        </view>
      </block>
      <block wx:else>
        <view class="u-fix-bottom {{isIphoneX ? 'has-safe-padding' : ''}}">
          <button class="u-fix-bottom--bar is-button" open-type="getUserInfo" bindgetuserinfo="getUserInfo" data-type="read">
            <image class="u-fix-bottom--icon" src="{{prePath}}/icons/article_delayread.png" />
            <text>稍后阅读</text>
          </button>
          <button class="u-fix-bottom--bar is-button" open-type="getUserInfo" bindgetuserinfo="getUserInfo" data-type="comment">
            <image class="u-fix-bottom--icon" src="{{prePath}}/icons/article_comment.png" />
            <text>评论</text>
          </button>
        </view>
      </block>
    </block>
    <view class="{{isIphoneX ? 'has-safe-padding' : ''}}"></view>
  </scroll-view>
  <settingEntry hasComment pageLogin="{{isLogin}}"></settingEntry>
</view>
